---
title: "ZIP使うとなんで圧縮できるの？簡単な圧縮・解凍CLIをRustで作ってみた"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["rust", "zip", "compression"]
published: false
---

「zip 使うかー。...そもそもなんで zip で圧縮できるんだっけ。あれ？俺圧縮のあの字も知らなくね？？」とふと思ったので、とりあえず圧縮・解凍の原理理解だけする CLI を、勉強も兼ねて Rust で作ってみました。

## 筆者の前提知識

- なんか知らんが zip コマンドでファイルを小さくできる
- なんか知らんが unzip でもとに戻せる
- 圧縮アルゴリズムやツールが色々あることは知ってる
- zip ならだいたい半分くらいになる
- Rust 初学者

## この記事でやらないこと

- ZIP の詳しい説明
- 圧縮アルゴリズムの詳しい説明

## まずは ChatGPT に圧縮の原理を聞いてみる

（会話内容は適宜添削しています）

ワイ「zip 使うとなんで圧縮できるの？そもそもなんでサイズが減らせるのか、というところからよくわかってないんだけど」

🤖「ZIP などの圧縮形式がファイルサイズを小さくできる理由は、データの冗長性（繰り返しやパターン）をうまく利用しているからです。

たとえば、「AAAAAAAAAABBBCCCC」というデータがあったとします。このままでは 18 文字ありますが、圧縮アルゴリズムはこれを「10A3B4C」のように、同じ文字の繰り返しをカウントして短く表現できます。これは「ランレングス符号化」という圧縮方法の一例です。」

ワイ「あーなるほどね、わかりやすい。これなら俺でもできそう」

今回はアルゴリズムを突き詰めるのは諦め、この方式でやってみることにします。

---

となると解凍が気になる。

ワイ「じゃあなんで解凍もできるの？あと、解凍に必要な情報も含めるだろうから結果的にサイズ増えちゃわない？」

🤖「圧縮アルゴリズムは、圧縮時に必要な情報をヘッダーなどに含めて保存しています。解凍時にはこの情報を使って元のデータに戻します。追加情報は少量にして効率的に記録することで、全体的な圧縮効果が大きくなります。」

ワイ「ふむ」
ワイ「極論を言えば記録の仕方を誤ったら圧縮後のサイズが増えることもあるってことだよね」

🤖「その通りです[^1]。 極論を言えば、圧縮の方法が不適切だったり、データの性質に合わなかった場合、圧縮後のファイルサイズが逆に増えることもあります。
例えば：

- すでに圧縮されているデータ
- ランダムなデータ
- 不適切な圧縮方法

などが挙げられます。」

[^1]: 「その通りです。」って言われると相手 AI でもちょっと嬉しくなっちゃうよね（単純）

ワイ「確かにランダムだと増えそうなイメージ。おけ、大体わかったわ」

## Rust で簡単な圧縮・解凍 CLI ツールを作る

ではランレングス符号化を実装します。

単純にランレングス符号化を実装するのはつまらないので今回はドドスコ特化のドドスコ ZIP を実装してみます。
以下の文章を "dodosuko.txt", UTF-8 で保存します。

```txt:dodosuko.txt
ドドスコスコスコドドスコスコスコドドスコスコスコラブ注入
```

いかにも圧縮しやすそうな文字列ですね

圧縮前のサイズは

```sh
❯ ls -l dodosuko.txt
-rw-rw-r-- 1 senken senken 85 Sep  9 01:47 dodosuko.txt
```

サイズは 28 文字 \* 3 バイト = 84 バイトです。

そして「ド」「スコ」「ラブ注入」をそれぞれ「1D」「2S」「3L」というように置換してみます。つまり、

```txt:dodosuko.dodosuko-zip
1D3S1D3S1D3S1L
```

となり、サイズは 14 文字 \* 1 B = 14 バイトになる想定です。
圧縮ファイル拡張子は `.dodosuko-zip` とします。
